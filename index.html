<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelHub Ultimate - åŠŸèƒ½å…¨å¼€ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .active-day { background: #4f46e5 !important; color: white !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .cat-sight { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .cat-food { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .cat-hotel { background: #f3e8ff; color: #7e22ce; border: 1px solid #e9d5ff; }
        .cat-activity { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        #search-results { max-height: 400px; overflow-y: auto; z-index: 2000; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        .search-item { transition: all 0.2s; border-bottom: 1px solid #f1f5f9; }
        .search-item:hover { background-color: #f8fafc; cursor: pointer; padding-left: 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden font-sans">

    <header class="h-20 border-b bg-white flex items-center justify-between px-6 shrink-0 z-50 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg">T</div>
                <h1 class="text-lg font-bold tracking-tighter italic hidden md:block">TravelHub <span class="text-indigo-600">PRO</span></h1>
            </div>
            <input type="date" id="start-date" onchange="updateDates()" class="bg-slate-100 px-3 py-1.5 rounded-lg text-xs font-bold text-indigo-600 outline-none hover:bg-slate-200 transition">
        </div>
        
        <div class="flex gap-1.5 overflow-x-auto max-w-[25vw] no-scrollbar" id="day-selector"></div>
        
        <div class="flex gap-2">
            <button onclick="toggleOptimizeMode()" id="btn-opt-mode" class="bg-emerald-50 text-emerald-600 border border-emerald-200 px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-emerald-100 transition whitespace-nowrap">ğŸª„ é¡ºè·¯ä¼˜åŒ–</button>
            <button onclick="openOverview()" class="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-slate-800 transition whitespace-nowrap">ğŸ“Š æ€»è§ˆ</button>
            <button onclick="exportData()" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-amber-600 transition whitespace-nowrap">ğŸ“¤ å¯¼å‡º</button>
            <button onclick="importData()" class="bg-sky-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-sky-600 transition whitespace-nowrap">ğŸ“¥ å¯¼å…¥</button>
            <button onclick="addDay()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold hover:bg-indigo-700 transition whitespace-nowrap">+ å¤©</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-80 border-r bg-white flex flex-col shrink-0">
            <div class="p-4 border-b relative z-30">
                <div class="relative">
                    <input id="map-search" type="text" placeholder="ğŸ” è¾“å…¥åœ°ç‚¹(ç²¾ç¡®æœç´¢å·²å¼€å¯)" 
                           class="w-full px-4 py-3 bg-slate-100 border-none rounded-xl text-xs focus:ring-2 focus:ring-indigo-500 outline-none transition font-medium">
                    <button onclick="clearSearch()" class="absolute right-3 top-2.5 text-slate-300 hover:text-slate-500 text-sm">âœ•</button>
                </div>
                <div id="search-results" class="absolute left-4 right-4 mt-2 bg-white border rounded-xl hidden shadow-2xl overflow-hidden custom-scrollbar"></div>
            </div>
            <div id="library-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20 no-scrollbar"></div>
        </aside>

        <section class="flex-1 overflow-y-auto p-6 bg-[#f8fafc] relative scroll-smooth custom-scrollbar">
            <div class="max-w-3xl mx-auto pb-24">
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <h2 id="current-day-title" class="text-3xl font-black text-slate-800 italic">Day 1</h2>
                        <p id="current-day-date" class="text-indigo-500 text-xs font-bold mt-1 tracking-widest uppercase"></p>
                    </div>
                </div>
                <div class="space-y-6" id="time-slots"></div>
            </div>

            <div id="opt-bar" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl z-[60] hidden flex items-center gap-4 animate-in slide-in-from-bottom duration-300">
                <span class="text-xs font-bold whitespace-nowrap">å·²é€‰ <span id="opt-count" class="text-emerald-400 text-base">0</span> ä¸ª</span>
                <button onclick="runOptimization()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition">å¼€å§‹æ’åº</button>
                <button onclick="toggleOptimizeMode()" class="text-slate-400 hover:text-white text-xs">å–æ¶ˆ</button>
            </div>
        </section>

        <aside class="w-[28rem] border-l bg-white hidden xl:flex flex-col shrink-0 p-6">
            <div id="map" class="h-3/5 rounded-[2rem] shadow-lg border-4 border-white mb-6 z-10"></div>
            <div class="bg-indigo-50 rounded-[2rem] p-6 text-indigo-900 border border-indigo-100 h-2/5 flex flex-col justify-center relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-100 rounded-full opacity-50 blur-3xl"></div>
                <p class="text-[10px] opacity-60 uppercase font-bold tracking-widest relative z-10">Day <span id="stat-day">1</span> é¢„ä¼°æ”¯å‡º</p>
                <p class="text-4xl font-black mt-2 relative z-10">Â¥ <span id="total-cost">0</span></p>
                <div class="mt-6 space-y-2 relative z-10">
                    <div class="flex justify-between text-xs font-bold text-indigo-400"><span>ä½å®¿</span><span id="cost-hotel">Â¥0</span></div>
                    <div class="flex justify-between text-xs font-bold text-indigo-400"><span>é¤é¥®</span><span id="cost-food">Â¥0</span></div>
                    <div class="flex justify-between text-xs font-bold text-indigo-400"><span>å…¶ä»–</span><span id="cost-other">Â¥0</span></div>
                </div>
            </div>
        </aside>
    </main>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-lg p-8 shadow-2xl animate-in zoom-in duration-200 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-black mb-6 shrink-0">ç¼–è¾‘è¡Œç¨‹å†…å®¹</h3>
            <div class="space-y-4 overflow-y-auto pr-2 custom-scrollbar flex-1">
                
                <div class="relative group cursor-pointer" onclick="document.getElementById('img-upload').click()">
                    <div id="img-preview-area" class="h-32 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center hover:bg-white hover:border-indigo-300 transition overflow-hidden">
                        <img id="edit-img-show" class="hidden w-full h-full object-cover">
                        <div id="img-placeholder" class="text-center">
                            <span class="text-2xl">ğŸ“·</span>
                            <p class="text-[10px] font-bold text-slate-400 mt-1">ä¸Šä¼ å›¾ç‰‡ã€è½¦ç¥¨æˆ–é¢„è®¢ç¡®è®¤å•</p>
                        </div>
                    </div>
                    <input type="file" id="img-upload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setEditCat('sight')" class="cat-btn p-2 rounded-xl text-[10px] font-bold border" data-cat="sight">æ™¯ç‚¹</button>
                    <button onclick="setEditCat('food')" class="cat-btn p-2 rounded-xl text-[10px] font-bold border" data-cat="food">é¤é£Ÿ</button>
                    <button onclick="setEditCat('hotel')" class="cat-btn p-2 rounded-xl text-[10px] font-bold border" data-cat="hotel">ä½å®¿</button>
                    <button onclick="setEditCat('activity')" class="cat-btn p-2 rounded-xl text-[10px] font-bold border" data-cat="activity">æ´»åŠ¨</button>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-1">è®¡åˆ’æ—¶é—´</label>
                    <select id="det-slot" class="w-full px-3 py-2 bg-slate-50 rounded-lg outline-none font-bold text-sm text-slate-700 border border-slate-100">
                        <option value="morning">ä¸Šåˆ (Morning)</option>
                        <option value="noon">ä¸­åˆ (Noon)</option>
                        <option value="afternoon">ä¸‹åˆ (Afternoon)</option>
                        <option value="evening">æ™šä¸Š (Evening)</option>
                    </select>
                </div>
                <input id="det-name" type="text" class="w-full px-4 py-3 bg-slate-50 rounded-xl outline-none font-bold text-sm border border-slate-100" placeholder="åœ°ç‚¹åç§°">
                <div class="grid grid-cols-2 gap-3">
                    <input id="det-cost" type="number" class="px-3 py-2 bg-slate-50 rounded-lg outline-none text-sm border border-slate-100" placeholder="è´¹ç”¨ (Â¥)">
                    <input id="det-dur" type="number" class="px-3 py-2 bg-slate-50 rounded-lg outline-none text-sm border border-slate-100" placeholder="æ—¶é•¿ (åˆ†)">
                </div>
                <textarea id="det-note" rows="3" class="w-full px-4 py-3 bg-slate-50 rounded-xl outline-none resize-none text-xs border border-slate-100" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å¤‡æ³¨æˆ–æ”»ç•¥..."></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-400 font-bold text-xs">å–æ¶ˆ</button>
                <button onclick="saveDetails()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs shadow-lg">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <div id="overview-modal" class="fixed inset-0 bg-white z-[200] hidden overflow-y-auto">
        <div class="max-w-6xl mx-auto p-12 relative">
            <button onclick="closeOverview()" class="absolute top-12 right-12 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold">âœ•</button>
            <div class="flex justify-between items-end mb-10 border-b pb-6">
                <div>
                    <h2 class="text-4xl font-black italic">Trip Overview</h2>
                    <p class="text-slate-400 font-bold text-sm mt-2 tracking-widest uppercase">å…¨è¡Œç¨‹æ¸…å• & é¢„ç®—ç»Ÿè®¡</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Grand Total</p>
                    <p class="text-4xl font-black text-indigo-600">Â¥ <span id="overview-total-cost">0</span></p>
                </div>
            </div>
            <div id="overview-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </div>

    <script>
        let currentDay = 0, daysData = JSON.parse(localStorage.getItem('travel_v13_days')) || [[]];
        let poiLibrary = JSON.parse(localStorage.getItem('travel_v13_lib')) || [];
        let startDate = localStorage.getItem('travel_v13_start') || new Date().toISOString().split('T')[0];
        let map, markers = [], editingId = null, tempCat = 'sight', tempImg = "", isOptimizeMode = false, selectedForOpt = new Set();

        window.onload = () => {
            document.getElementById('start-date').value = startDate;
            initMap(); initSearch(); renderDays(); renderLibrary(); updateUI();
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([31.23, 121.47], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        // --- æ ¸å¿ƒï¼šå›¾ç‰‡å¤„ç†å‡½æ•° ---
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImg = e.target.result;
                    const imgShow = document.getElementById('edit-img-show');
                    imgShow.src = tempImg;
                    imgShow.classList.remove('hidden');
                    document.getElementById('img-placeholder').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- æœç´¢é€»è¾‘ ---
        function initSearch() {
            const input = document.getElementById('map-search');
            const resPanel = document.getElementById('search-results');
            let timer;

            input.addEventListener('input', (e) => {
                clearTimeout(timer);
                const q = e.target.value.trim();
                if (q.length < 2) { resPanel.classList.add('hidden'); return; }
                timer = setTimeout(async () => {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=8&addressdetails=1&accept-language=zh-CN`);
                    const data = await response.json();
                    if (data.length > 0) {
                        resPanel.innerHTML = data.map(it => {
                            const name = it.display_name.split(',')[0];
                            return `<div class="search-item p-4" onclick="selectLocation('${name.replace(/'/g, "\\'")}', '${it.display_name.replace(/'/g, "\\'")}', ${it.lon}, ${it.lat})">
                                <div class="font-bold text-sm text-slate-800">${name}</div>
                                <div class="text-[10px] text-slate-500">ğŸ“ ${it.display_name}</div>
                            </div>`;
                        }).join('');
                        resPanel.classList.remove('hidden');
                    }
                }, 500);
            });
        }

        window.selectLocation = (name, addr, lng, lat) => {
            poiLibrary.unshift({ id: Date.now().toString(), name, addr, lng, lat, cat: 'sight' });
            renderLibrary();
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('map-search').value = "";
            map.flyTo([lat, lng], 15);
        };

        // --- UI æ›´æ–° (åŒ…å«å›¾ç‰‡ç¼©ç•¥å›¾æ˜¾ç¤º) ---
        function updateUI() {
            const slotNames = ['morning', 'noon', 'afternoon', 'evening'];
            const slotTitles = {'morning': 'â˜€ï¸ ä¸Šåˆ', 'noon': 'ğŸ´ ä¸­åˆ', 'afternoon': 'ğŸŒ‡ ä¸‹åˆ', 'evening': 'ğŸŒ™ æ™šä¸Š'};
            const container = document.getElementById('time-slots');
            container.innerHTML = ''; 
            
            markers.forEach(m => m.remove()); markers = [];
            let dayTotal = 0, catCosts = { hotel:0, food:0, activity:0, sight:0 };

            document.getElementById('current-day-title').innerText = `Day ${currentDay + 1}`;
            document.getElementById('current-day-date').innerText = getDayDate(currentDay);
            document.getElementById('stat-day').innerText = currentDay + 1;

            slotNames.forEach(slot => {
                container.innerHTML += `<div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100/50 mb-4">
                    <h3 class="font-black text-slate-300 text-xs mb-3 flex items-center gap-2 uppercase tracking-wider">${slotTitles[slot]}</h3>
                    <div id="slot-${slot}" class="space-y-3 min-h-[40px]"></div>
                </div>`;
            });

            daysData[currentDay].forEach((item) => {
                const cost = parseFloat(item.cost || 0);
                dayTotal += cost;
                if(catCosts[item.cat] !== undefined) catCosts[item.cat] += cost; else catCosts.activity += cost;

                const card = document.createElement('div');
                card.className = `flex gap-3 p-3 bg-white border border-slate-100 rounded-xl transition-all shadow-sm group`;
                
                // è¡Œç¨‹é¡¹ä¸­çš„å›¾ç‰‡å±•ç¤ºé€»è¾‘
                const imgThumb = item.img ? `<div class="w-14 h-14 shrink-0 rounded-lg overflow-hidden border border-slate-100 shadow-inner"><img src="${item.img}" class="w-full h-full object-cover"></div>` : '';

                card.innerHTML = `
                    ${imgThumb}
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="cat-${item.cat} text-[8px] font-black px-1.5 py-0.5 rounded uppercase">${item.cat}</span>
                            <h4 class="text-sm font-bold text-slate-800 truncate">${item.name}</h4>
                        </div>
                        <div class="text-[9px] text-slate-400 truncate mb-1">ğŸ“ ${item.addr || ''}</div>
                        ${item.note ? `<div class="text-[9px] text-slate-500 italic mb-2 line-clamp-1 opacity-80">â€œ${item.note}â€</div>` : ''}
                        <div class="flex gap-3 text-[10px] font-bold">
                            <span class="text-indigo-600">Â¥ ${item.cost || 0}</span>
                            <span class="text-slate-400">â± ${item.duration || 0}m</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="openEdit('${item.id}')" class="p-1.5 bg-indigo-50 text-indigo-600 rounded">âœ</button>
                        <button onclick="removeItem('${item.id}')" class="p-1.5 bg-red-50 text-red-400 rounded">âœ•</button>
                    </div>`;
                document.getElementById(`slot-${item.slot || 'morning'}`).appendChild(card);
                markers.push(L.marker([item.lat, item.lng]).addTo(map).bindPopup(item.name));
            });

            document.getElementById('total-cost').innerText = dayTotal.toLocaleString();
            document.getElementById('cost-hotel').innerText = `Â¥${catCosts.hotel}`;
            document.getElementById('cost-food').innerText = `Â¥${catCosts.food}`;
            document.getElementById('cost-other').innerText = `Â¥${catCosts.activity + catCosts.sight}`;
            if(markers.length > 0) map.fitBounds(new L.featureGroup(markers).getBounds().pad(0.3));
            saveToLocal();
        }

        // --- ç¼–è¾‘é€»è¾‘ ---
        window.openEdit = (id) => {
            editingId = id;
            const it = daysData[currentDay].find(x => x.id === id);
            document.getElementById('det-name').value = it.name;
            document.getElementById('det-slot').value = it.slot || 'morning';
            document.getElementById('det-cost').value = it.cost || 0;
            document.getElementById('det-dur').value = it.duration || 60;
            document.getElementById('det-note').value = it.note || "";
            tempImg = it.img || "";
            tempCat = it.cat || 'sight';
            
            const imgShow = document.getElementById('edit-img-show');
            const placeholder = document.getElementById('img-placeholder');
            if(tempImg) {
                imgShow.src = tempImg;
                imgShow.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                imgShow.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
            
            setEditCat(tempCat);
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveDetails = () => {
            const it = daysData[currentDay].find(x => x.id === editingId);
            it.name = document.getElementById('det-name').value;
            it.slot = document.getElementById('det-slot').value;
            it.cost = document.getElementById('det-cost').value;
            it.duration = document.getElementById('det-dur').value;
            it.note = document.getElementById('det-note').value;
            it.cat = tempCat;
            it.img = tempImg;
            updateUI(); closeModal();
        };

        // --- æ€»è§ˆé€»è¾‘ (åŒ…å«å›¾ç‰‡) ---
        window.openOverview = () => {
            const content = document.getElementById('overview-content');
            let grandTotal = 0;
            const slotLabel = { 'morning': 'ä¸Šåˆ', 'noon': 'ä¸­åˆ', 'afternoon': 'ä¸‹åˆ', 'evening': 'æ™šä¸Š' };
            const slotWeight = { 'morning': 0, 'noon': 1, 'afternoon': 2, 'evening': 3 };

            content.innerHTML = daysData.map((day, i) => {
                const dayTotal = day.reduce((sum, item) => sum + parseFloat(item.cost || 0), 0);
                grandTotal += dayTotal;
                const sortedDay = [...day].sort((a, b) => slotWeight[a.slot || 'morning'] - slotWeight[b.slot || 'morning']);

                return `<div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h4 class="font-black">Day ${i+1}</h4>
                        <span class="text-xs font-bold text-indigo-600">Â¥${dayTotal}</span>
                    </div>
                    <div class="space-y-4">
                        ${sortedDay.map(it => `
                            <div class="flex gap-3">
                                ${it.img ? `<div class="w-10 h-10 rounded overflow-hidden shrink-0 shadow-sm"><img src="${it.img}" class="w-full h-full object-cover"></div>` : '<div class="w-10 h-10 bg-slate-200 rounded shrink-0"></div>'}
                                <div class="min-w-0 flex-1">
                                    <div class="flex justify-between text-[8px] font-bold text-slate-400 uppercase">
                                        <span>${slotLabel[it.slot||'morning']}</span>
                                        <span class="text-amber-600">Â¥${it.cost}</span>
                                    </div>
                                    <p class="text-xs font-bold truncate">${it.name}</p>
                                    ${it.note ? `<p class="text-[9px] text-slate-400 truncate italic">â€œ${it.note}â€</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
            document.getElementById('overview-total-cost').innerText = grandTotal.toLocaleString();
            document.getElementById('overview-modal').classList.remove('hidden');
        };

        // --- å…¶ä»–åŸºç¡€åŠŸèƒ½ ---
        window.renderLibrary = () => {
            document.getElementById('library-list').innerHTML = poiLibrary.map(p => `<div class="p-3 border rounded-xl bg-white"><h4 class="font-bold text-xs truncate">${p.name}</h4><button onclick="addToDay('${p.id}')" class="mt-2 w-full py-1.5 bg-slate-900 text-white rounded-lg text-[10px] font-bold">æ·»åŠ </button></div>`).join('');
        };
        window.exportData = () => {
            const data = btoa(encodeURIComponent(JSON.stringify({ v: "1.3", start: startDate, days: daysData, lib: poiLibrary })));
            const el = document.createElement('textarea'); el.value = data; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("âœ… æ•°æ®å·²å¤åˆ¶ï¼");
        };
        window.importData = () => {
            const code = prompt("ç²˜è´´è¡Œç¨‹ä»£ç ï¼š"); if (!code) return;
            try {
                const d = JSON.parse(decodeURIComponent(atob(code)));
                startDate = d.start; daysData = d.days; poiLibrary = d.lib;
                saveToLocal(); location.reload();
            } catch (e) { alert("æ— æ•ˆä»£ç "); }
        };
        window.addToDay = (id) => { const it = poiLibrary.find(x => x.id === id); daysData[currentDay].push({ ...it, id: Date.now().toString(), slot: 'morning', cost: 0, duration: 60, note: "", img: "" }); updateUI(); };
        window.removeItem = (id) => { daysData[currentDay] = daysData[currentDay].filter(x => x.id !== id); updateUI(); };
        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.closeOverview = () => document.getElementById('overview-modal').classList.add('hidden');
        window.setEditCat = (c) => {
            tempCat = c;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.className = (btn.dataset.cat === c) ? 
                    "cat-btn p-2 rounded-xl text-[10px] font-bold border-2 border-indigo-600 bg-indigo-50 text-indigo-600" : 
                    "cat-btn p-2 rounded-xl text-[10px] font-bold border border-slate-200 bg-slate-50 text-slate-400";
            });
        };
        window.saveToLocal = () => { localStorage.setItem('travel_v13_days', JSON.stringify(daysData)); localStorage.setItem('travel_v13_lib', JSON.stringify(poiLibrary)); localStorage.setItem('travel_v13_start', startDate); };
        function getDayDate(idx) { const d = new Date(startDate); d.setDate(d.getDate() + idx); return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' }); }
        window.updateDates = () => { startDate = document.getElementById('start-date').value; updateUI(); renderDays(); };
        window.addDay = () => { daysData.push([]); renderDays(); switchDay(daysData.length-1); };
        window.switchDay = (i) => { currentDay = i; updateUI(); renderDays(); };
        window.renderDays = () => { document.getElementById('day-selector').innerHTML = daysData.map((_, i) => `<button onclick="switchDay(${i})" class="w-8 h-8 rounded-lg text-[10px] font-black border ${i===currentDay?'active-day':'bg-white text-slate-300'}">${i+1}</button>`).join(''); };
        window.clearSearch = () => { document.getElementById('map-search').value = ""; document.getElementById('search-results').classList.add('hidden'); };
        window.toggleOptimizeMode = () => { isOptimizeMode = !isOptimizeMode; updateUI(); };
    </script>
</body>
</html>
